<!DOCTYPE html>
<html lang="pt">
<head>
    <title>
        
External Storage

    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="/static/css/icons.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bulma.min.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bookwyrm.css?v076">

    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Bookwyrm Documentation">
    <meta name="og:title" content="Bookwyrm Documentation">
    <meta name="twitter:description" content="Documentation for using and contributing to BookWyrm">
    <meta name="og:description" content="Documentation for using and contributing to BookWyrm">

    <meta name="twitter:image" content="">
    <meta name="og:image" content="">
    <meta name="twitter:image:alt" content="BookWyrm Logo">

    <meta charset="UTF-8">
</head>
<body>
<nav class="navbar container is-max-desktop" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="https://joinbookwyrm.com/">
            <img class="image logo" src="/static/images/logo-small.png" alt="Go back to the homepage">
        </a>
        <a href="/" class="navbar-item has-text-link has-text-weight-bold">
            Documentação
        </a>
        <a role="button" class="navbar-burger" data-target="main-nav" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div class="navbar-menu" id="main-nav">
        <div class="navbar-start">
            <a href="https://joinbookwyrm.com/pt-br/instances" class="navbar-item">
                Registrar
            </a>
            <a href="https://joinbookwyrm.com/pt-br/get-involved" class="navbar-item">
                Participe
            </a>
            <a href="https://www.patreon.com/bookwyrm" class="navbar-item">
                Suporte
            </a>
            <a href="https://github.com/bookwyrm-social/bookwyrm" class="navbar-item">
                Código
            </a>
        </div>
    </div>
</nav>


<div class="columns">
    <nav class="menu column is-one-quarter is-hidden-touch pl-6 mt-4" id="menu">
        <h2 class="menu-label">Language & Version</a></h2>
        <div class="select">
            <select aria-label="Select a language" id="language_selection">
                
                <option value="" >English (US)</option>
                
                <option value="de/" >Deutsch</option>
                
                <option value="fr/" >Français</option>
                
                <option value="pl/" >Polski</option>
                
                <option value="pt-br/" selected>Português do Brasil</option>
                
                <option value="ro/" >Română</option>
                
          </select>
        </div>
        <div class="select">
            <select aria-label="Previous versions" id="version_selection">
                
                <option value="development" >development</option>
                
                <option value="v0.7.5" selected>v0.7.5</option>
                
            </select>
        </div>
        
        <h2 class="menu-label">Using BookWyrm</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/v0.7.5/pt-br/main-menu.html" class="has-background-inherit" >Main Menu & Timelines</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/shelves.html" class="has-background-inherit" >Shelves & Reading Status</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/adding-books.html" class="has-background-inherit" >Adicionar livros</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/posting-statuses.html" class="has-background-inherit" >Posting Statuses</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/lists.html" class="has-background-inherit" >Lists</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/privacy-controls.html" class="has-background-inherit" >Privacy Controls</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/groups.html" class="has-background-inherit" >Groups</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/rss-feeds.html" class="has-background-inherit" >RSS Feeds</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/user-migration.html" class="has-background-inherit" >User Migration and Aliases</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Running BookWyrm</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/v0.7.5/pt-br/install-prod.html" class="has-background-inherit" >Installing in Production</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/install-prod-dockerless.html" class="has-background-inherit" >Installing Without Docker</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/updating.html" class="has-background-inherit" >Updating Your Instance</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/reverse-proxy.html" class="has-background-inherit" >Using a Reverse-Proxy</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/moderation.html" class="has-background-inherit" >Moderation</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/monitoring-queue.html" class="has-background-inherit" >Monitoring Queue</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/external-storage.html" class="has-background-inherit" class="is-active">External Storage</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/optional_features.html" class="has-background-inherit" >Optional features</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/cli.html" class="has-background-inherit" >Command Line Tool</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Contributing</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/v0.7.5/pt-br/contributing.html" class="has-background-inherit" ></a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/style_guide.html" class="has-background-inherit" ></a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/translation.html" class="has-background-inherit" ></a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/documentation.html" class="has-background-inherit" >Documentation</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/install-dev.html" class="has-background-inherit" >Developer Environment</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/debug_toolbar.html" class="has-background-inherit" >Django Debug Toolbar</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Codebase</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/v0.7.5/pt-br/activitypub.html" class="has-background-inherit" >ActivityPub</a>
            </li>
            
            <li>
                <a href="/v0.7.5/pt-br/permissions.html" class="has-background-inherit" >Permissões</a>
            </li>
            
        </ul>
        
    </nav>

    <div class="column">
        <div class="container is-max-desktop">
            <section class="section">
                <header class="content block column is-offset-one-quarter pl-2">
                    
<h1 class="title is-1">External Storage</h1>

                </header>
                
<section class="block content">
    <p>Por padrão, a BookWyrm usa o armazenamento local para os arquivos estáticos (ícones, avatar padrão, etc.) e as mídias (avatares dos usuários, capas de livros, etc.), mas você pode usar um armazenament externo para distribuir esses arquivos. A BooKWyrm utiliza o <code>django-storages</code> para lidar com o armazenamento externo, como serviços compatíveis com S3, Apache Libcloud ou SFTP.</p>
<h2 id="servicos-compativeis-com-s3"><a class="headerlink" href="#servicos-compativeis-com-s3">Serviços compatíveis com S3</a></h2>
<h3 id="configuracao"><a class="headerlink" href="#configuracao">Configuração</a></h3>
<p>Crie um bucket em seu serviço compatível com S3 favorito, junto com uma Access Key ID e uma Scret Access Key. Eles podem ser auto-hospedados, como <a href="https://ceph.io/en/">Ceph</a> (LGPL 2.1/3.0) ou <a href="https://min.io/">MinIO</a> (GNU AGPL v3.0), ou comercial (<a href="https://www.scaleway.com/en/docs/object-storage-feature/">Scaleway</a>, <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-digitalocean-space-and-api-key">Digital Ocean</a>…).</p>
<p>Este guia foi testado no Scaleway Object Storage. Se você usa outro serviço, por favor nos conte sua experiência (especialmente se fez algum outro passo) criando um problema (issue) no repositório da <a href="https://github.com/bookwyrm-social/documentation">documentação da BookWyrm Documentation</a>.</p>
<h3 id="o-que-lhe-espera"><a class="headerlink" href="#o-que-lhe-espera">O que lhe espera</a></h3>
<p>Se você está iniciando uma nova instância BookWyrm, o processo será:</p>
<ul>
<li>Configurar seu serviço de armazenamento externo</li>
<li>Habilitar o armazenamento externo na BookWyrm</li>
<li>Inicie sua instância BookWyrm</li>
<li>Atualize o conector da instância</li>
</ul>
<p>Se você já iniciou a instância, e imagens foram enviadas para o armazenamento local, o processo será:</p>
<ul>
<li>Configure seu serviço de armazenamento externo</li>
<li>Copie sua mídia local para o armazenamento externo</li>
<li>Habilite o armazenamento externo na BookWyrm</li>
<li>Reinicie sua instância BookWyrm</li>
<li>Atualize o conector da instância</li>
</ul>
<h3 id="configuracoes-da-bookwyrm"><a class="headerlink" href="#configuracoes-da-bookwyrm">Configurações da BookWyrm</a></h3>
<p>Edite seu arquivo <code>.env</code> descomentando as seguintes linhas:</p>
<ul>
<li><code>AWS_ACCESS_KEY_ID</code>: sua ID de acesso</li>
<li><code>AWS_SECRET_ACCESS_KEY</code>: sua chave de acesso secreta</li>
<li><code>AWS_STORAGE_BUCKET_NAME</code>: o nome do seu bucket</li>
<li><code>AWS_S3_REGION_NAME</code>: e.g. <code>"eu-west-1"</code> for AWS, <code>"fr-par"</code> for Scaleway, <code>"nyc3"</code> for Digital Ocean or <code>"cluster-id"</code> for Linode</li>
</ul>
<p>Se seu serviço compatível com S3 for a Amazon AWS, já está tudo pronto. Se não, você deverá descomentar as seguintes linhas:</p>
<ul>
<li><code>AWS_S3_CUSTOM_DOMAIN</code>: the domain that will serve the assets:</li>
<li>for Scaleway, e.g. <code>"example-bucket-name.s3.fr-par.scw.cloud"</code></li>
<li>for Digital Ocean, e.g. <code>"${AWS_STORAGE_BUCKET_NAME}.${AWS_S3_REGION_NAME}.digitaloceanspaces.com"</code></li>
<li>for Linode Object Storage, this should be set to the cluster domain, e.g. <code>"eu-central-1.linodeobjects.com"</code></li>
<li><code>AWS_S3_ENDPOINT_URL</code>: the S3 API endpoint:</li>
<li>for Scaleway, e.g. <code>"https://s3.fr-par.scw.cloud"</code></li>
<li>for Digital Ocean, e.g. <code>"https://${AWS_S3_REGION_NAME}.digitaloceanspaces.com"</code></li>
<li>For Linode Object Storage, set this to the cluster domain, e.g. <code>"https://eu-central-1.linodeobjects.com"</code></li>
</ul>
<p>For many S3 compatible services, the default <code>ACL</code> is <code>"public-read"</code>, and this is what BookWyrm defaults to. If you are using Backblaze (B2) you need to explicitly set the default ACL to be empty in your <code>.env</code> file:</p>
<div class="highlight"><pre><span></span><code>AWS_DEFAULT_ACL=&quot;&quot;
</code></pre></div>

<h3 id="copiando-a-midia-local-para-o-armazenamento-externo"><a class="headerlink" href="#copiando-a-midia-local-para-o-armazenamento-externo">Copiando a mídia local para o armazenamento externo</a></h3>
<p>Se sua instância BookWyrm já está rodando e já recebeu mídias (avatares de usuários, capas de livros…), você precisará migrar essa mídia enviada para seu bucket.</p>
<p>Essa tarefá é feita com o comando:</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>copy_media_to_s3
</code></pre></div>

<h3 id="habilitando-o-armazenamento-externo-na-bookwyrm"><a class="headerlink" href="#habilitando-o-armazenamento-externo-na-bookwyrm">Habilitando o armazenamento externo na BookWyrm</a></h3>
<p>Para habilitar o armazenamento externo compatível com S3, você deverá editar seu arquivo <code>.env</code> e mudar a propriedade da variável <code>USE_S3</code> de <code>false</code> para <code>true</code>:</p>
<div class="highlight"><pre><span></span><code>USE_S3=true
</code></pre></div>

<p><strong>Note</strong> that after <code>v0.7.5</code> all traffic is assumed to be HTTPS, so you need to ensure that your external storage is also served over HTTPS.</p>
<h4 id="arquivos-estaticos"><a class="headerlink" href="#arquivos-estaticos">Arquivos estáticos</a></h4>
<p>Then, you will need to run the following commands to compile the themes and copy all static assets to your S3 bucket:</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>compile_themes
./bw-dev<span class="w"> </span>collectstatic
</code></pre></div>

<h4 id="configuracoes-do-cors"><a class="headerlink" href="#configuracoes-do-cors">Configurações do CORS</a></h4>
<p>Once the static assets are collected, you will need to set up CORS for your bucket.</p>
<p>Some services like Digital Ocean provide an interface to set it up, see <a href="https://docs.digitalocean.com/products/spaces/how-to/configure-cors/">Digital Ocean doc: How to Configure CORS</a>.</p>
<p>If your service doesn’t provide an interface, you can still set up CORS with the command line.</p>
<p>Create a file called <code>cors.json</code>, with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;CORSRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;AllowedOrigins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://MY_DOMAIN_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;https://www.MY_DOMAIN_NAME&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;AllowedHeaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;AllowedMethods&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;MaxAgeSeconds&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;ExposeHeaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Etag&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>Replace <code>MY_DOMAIN_NAME</code> with the domain name(s) of your instance.</p>
<p>Then, run the following command:</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>set_cors_to_s3<span class="w"> </span>cors.json
</code></pre></div>

<p>No output means it should be good.</p>
<h3 id="additional-step-for-linode-object-storage-users"><a class="headerlink" href="#additional-step-for-linode-object-storage-users">Additional Step for Linode Object Storage Users</a></h3>
<p>For Linode, you now need to make an alteration to the <code>.env</code> to ensure that the generated links to your storage objects are correct. If you miss this step, all the links to images and static files (like css) will be broken. To fix this, you need to now insert the bucket-name into the <code>AWS_S3_CUSTOM_DOMAIN</code>, for example if your <code>AWS_STORAGE_BUCKET_NAME</code> is <code>"my-bookwyrm-bucket"</code>, then set it to:</p>
<div class="highlight"><pre><span></span><code>AWS_S3_CUSTOM_DOMAIN=my-bookwyrm-bucket.cluster-id.linodeobjects.com
</code></pre></div>

<p><em>Note</em>: From this point on, any bw-dev copy or sync commands will place objects into an incorrect location in your object store, so if you need to use them, revert to the previous setting, run and re-enable.</p>
<h3 id="user-export-and-import-files"><a class="headerlink" href="#user-export-and-import-files">User export and import files</a></h3>
<p>After <code>v0.7.5</code>, user export and import files are saved to local storage even if <code>USE_S3</code> is set to <code>true</code>. Generally it is safer to use local storage for these files, and keep your used storage under control by setting up the task to periodically delete old export and import files.</p>
<p>If you are running a large instance you may prefer to use S3 for these files as well. If so, you will need to set the environment variable <code>USE_S3_FOR_EXPORTS</code> to <code>true</code>.</p>
<h3 id="new-instance"><a class="headerlink" href="#new-instance">New Instance</a></h3>
<p>If you are starting a new BookWyrm instance, you can go back to the setup instructions right now: [<a href="install-prod.html">Docker</a>] [<a href="install-prod-dockerless.html">Dockerless</a>]. If not, keep on reading.</p>
<h3 id="restarting-your-instance"><a class="headerlink" href="#restarting-your-instance">Restarting your instance</a></h3>
<p>Once the media migration has been done and the static assets are collected, you can load the new <code>.env</code> configuration and restart your instance with:</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>

<p>If all goes well, your storage has been changed without server downtime. Se algumas fontes não aparecem (e o console JS do seu navegador alerta sobre o CORS), algo deu errado <a href="#cors-settings">aqui</a>. Nesse caso pode ser bom conferir os headers da solicitação HTTP em algum arquivo no seu bucket:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>OPTIONS<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Origin: http://MEU_DOMINIO&#39;</span><span class="w"> </span>http://ENDEREÇO_DO_BUCKET/static/images/logo-small.png<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Access-Control-Request-Method: GET&quot;</span>
</code></pre></div>

<p>Substitua <code>MEU_DOMINIO</code> com o domínio da sua instância e <code>ENDEREÇO_DO_BUCKET</code> com o endereço de seu bucket. Você pode substituir o caminho dos arquivos para algum que seja válido em seu bucket.</p>
<p>Se você ver alguma mensagem, especialmente alguma que comece com <code>&lt;Error&gt;&lt;Code&gt;CORSForbidden&lt;/Code&gt;</code>, não deu certo. Se você não ver mensagem alguma, funcionou.</p>
<p>Em uma instância ativa pode haver vários arquivos criados localmente durante a migração para o armazenamento externo, e reiniciar a aplicação pode fazê-la utilizar o armazenamento externo. Para garantir que os arquivos restantes sejam enviados ao armazenamento externo depois de alterar, você pode usar o seguinte comando, que irá enviar apenas arquivos que ainda não estejam no armazenamento externo:</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>sync_media_to_s3
</code></pre></div>

<h3 id="atualizando-o-conector-da-instancia"><a class="headerlink" href="#atualizando-o-conector-da-instancia">Atualizando o conector da instância</a></h3>
<p><em>Aviso: você pode pular este passo se está utilizando uma versão atualizada da BookWyrm; em setembro de 2021, o "self connector" foi removido no <a href="https://github.com/bookwyrm-social/bookwyrm/pull/1413">PR #1413</a></em></p>
<p>Para que o endereço correto seja utilizado ao mostrar resultados da pesquisa de livros locais, temos que alterar o valor da base do URL das imagens de capa.</p>
<p>Os dados do conector podem ser acessados pela interface de administração do Django presentes no endereço <code>http://MY_DOMAIN_NAME/admin</code>. O conector da sua própria instância é o primeiro registro no banco de dados, então você pode acessá-lo pelo seguinte endereço: <code>https://MEU_DOMINIO/admin/bookwyrm/connector/1/change/</code>.</p>
<p>O campo <em>URL das capas (Covers url)</em> é, por padrão, <code>https://MEU_DOMINIO/images</code>, você deve mudá-lo para <code>https://ENDEREÇO_DO_ARMAZENAMENTO_S3/images</code>. Então clique o botão de <em>Salvar</em> e voilà!</p>
<p>Você deverá atualizar o valor do <em>Covers url</em> toda vez que alterar o endereço de seu armazenamento.</p>
</section>

            </section>
        </div>
    </div>
</div>

<footer id="contentinfo" class="footer">
    <div class="container is-max-desktop">
        <div class="columns">
            <div class="column content">
                <p>
                    <strong>BookWyrm</strong> é um software colaborativo e anti-corporativo mantido por <a href='https://www.mousereeve.com/'>Mouse Reeve</a>.
                </p>
                <p>
                    Apoie a BookWyrm no <a href='https://www.patreon.com/bookwyrm' target='_blank'>Patreon</a>.
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">Participe</h3>
                <p>
                    <a href="https://github.com/bookwyrm-social">BookWyrm no GitHub</a>
                </p>
                <p>
                    <a href="https://github.com/bookwyrm-social/documentation/blob/main/content/running_bookwyrm/external-storage.md">Contribua para esta página</a>
                </p>
                <p>
                    <a href="https://twitter.com/BookWyrmSocial" target="_blank">
                        <span class="icon icon-twitter"><span class="is-sr-only">Twitter</span></span>
                    </a>
                    <a href="https://tech.lgbt/@bookwyrm" target="_blank" rel="me">
                        <span class="icon icon-mastodon"><span class="is-sr-only">Mastodon</span></span>
                    </a>
                    <a href="https://www.patreon.com/bookwyrm" target="_blank">
                        <span class="icon icon-patreon"><span class="is-sr-only">Patreon</span></span>
                    </a>
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">Saiba mais</h3>
                <p>
                    <a href="https://docs.joinbookwyrm.com">Documentação</a>
                </p>
                <p>
                    <a href="mailto:mousereeve@riseup.net">Falar com a administração</a>
                </p>
                <p>
                    <a href="https://raw.githubusercontent.com/bookwyrm-social/join-bookwyrm/main/LICENSE.md">Licença</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<script>
    var current_locale = "pt-br/";
    var current_version = "v0.7.5";
</script>
<script src="/static/js/bookwyrm.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>
        
ActivityPub

    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="/static/css/icons.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bulma.min.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bookwyrm.css">

    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Bookwyrm Documentation">
    <meta name="og:title" content="Bookwyrm Documentation">
    <meta name="twitter:description" content="Documentation for using and contributing to BookWyrm">
    <meta name="og:description" content="Documentation for using and contributing to BookWyrm">

    <meta name="twitter:image" content="">
    <meta name="og:image" content="">
    <meta name="twitter:image:alt" content="BookWyrm Logo">

    <meta charset="UTF-8">
</head>
<body>
<nav class="navbar container is-max-desktop" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="https://joinbookwyrm.com/">
            <img class="image logo" src="/static/images/logo-small.png" alt="Go back to the homepage">
        </a>
    </div>

    <div class="navbar-menu" id="main-nav">
        <div class="navbar-start">
            <a href="https://joinbookwyrm.com/instances" class="navbar-item">
                <span class="button is-success has-text-weight-normal has-text-white">Join</span>
            </a>
            <a href="https://joinbookwyrm.com/get-involved" class="navbar-item">
                Get involved
            </a>
            <a href="https://www.patreon.com/bookwyrm" class="navbar-item">
                Support
            </a>
            <a href="https://github.com/bookwyrm-social/bookwyrm" class="navbar-item">
                Code
            </a>
            <a href="#" class="navbar-item is-active">
                Documentation
            </a>
        </div>
    </div>
    <div class="navbar-end">
        <div class="navbar-item">
            <div class="select">
                <select aria-label="Select a language" id="language_selection">
                    
                    <option value="" selected>English (US)</option>
                    
                    <option value="de/" >Deutsch</option>
                    
                    <option value="fr/" >Français</option>
                    
                    <option value="pl/" >Polski</option>
                    
                    <option value="pt-br/" >Português do Brasil</option>
                    
                    <option value="ro/" >Română</option>
                    
              </select>
            </div>
        </div>
    </div>
</nav>

<div class="container is-max-desktop">
<section class="section">

    <header class="content block column is-offset-one-quarter pl-2">
        
<h1 class="title is-1">ActivityPub</h1>

    </header>
    <div class="columns">
	<nav class="menu column is-one-quarter mt-2">
        <div class="select">
            <select aria-label="Previous versions" id="version_selection">
                
                <option value="latest" >latest</option>
                
                <option value="v0.7.5" >v0.7.5</option>
                
            </select>
        </div>
            <h2 class="menu-label"><a href="/">Welcome</a></h2>
            
            <h2 class="menu-label">Using BookWyrm</h2>
            <ul class="menu-list">
                
                <li>
                    <a href="/posting-statuses.html" >Posting statuses</a>
                </li>
                
                <li>
                    <a href="/adding-books.html" >Adding Books</a>
                </li>
                
                <li>
                    <a href="/user-migration.html" >User migration and aliases</a>
                </li>
                
                <li>
                    <a href="/rss-feeds.html" >RSS Feeds</a>
                </li>
                
            </ul>
            
            <h2 class="menu-label">Running BookWyrm</h2>
            <ul class="menu-list">
                
                <li>
                    <a href="/install-prod.html" >Installing in Production</a>
                </li>
                
                <li>
                    <a href="/install-prod-dockerless.html" >Installing Without Docker</a>
                </li>
                
                <li>
                    <a href="/updating.html" >Updating Your Instance</a>
                </li>
                
                <li>
                    <a href="/updating-dockerless.html" >Updating Without Docker</a>
                </li>
                
                <li>
                    <a href="/reverse-proxy.html" >Using a Reverse-Proxy</a>
                </li>
                
                <li>
                    <a href="/moderation.html" >Moderation</a>
                </li>
                
                <li>
                    <a href="/monitoring-queue.html" >Monitoring Queue</a>
                </li>
                
                <li>
                    <a href="/external-storage.html" >External Storage</a>
                </li>
                
                <li>
                    <a href="/optional_features.html" >Optional features</a>
                </li>
                
                <li>
                    <a href="/cli.html" >Command Line Tool</a>
                </li>
                
                <li>
                    <a href="/management-commands.html" >Management Commands</a>
                </li>
                
            </ul>
            
            <h2 class="menu-label">Contributing</h2>
            <ul class="menu-list">
                
                <li>
                    <a href="/contributing.html" >How to Contribute</a>
                </li>
                
                <li>
                    <a href="/translation.html" >Translations</a>
                </li>
                
                <li>
                    <a href="/style_guide.html" >Style Guide</a>
                </li>
                
                <li>
                    <a href="/documentation.html" >Documentation</a>
                </li>
                
                <li>
                    <a href="/install-dev.html" >Developer Environment</a>
                </li>
                
                <li>
                    <a href="/debug_toolbar.html" >Django Debug Toolbar</a>
                </li>
                
                <li>
                    <a href="/codereview.html" >Code Review</a>
                </li>
                
            </ul>
            
            <h2 class="menu-label">Codebase</h2>
            <ul class="menu-list">
                
                <li>
                    <a href="/activitypub.html" class="is-active">ActivityPub</a>
                </li>
                
                <li>
                    <a href="/permissions.html" >Permissions</a>
                </li>
                
            </ul>
            
        </nav>

        <div class="column">
            
<section class="block content">
    <p>BookWyrm uses the <a href="http://activitypub.rocks/">ActivityPub</a> protocol to send and receive user activity between other BookWyrm instances and other services that implement ActivityPub, like <a href="https://joinmastodon.org/">Mastodon</a>. To handle book data, BookWyrm has a handful of extended Activity types which are not part of the standard, but are legible to other BookWyrm instances.</p>
<p>To view the ActivityPub data for a BookWyrm entity (user, book, list, etc) you can usually add <code>.json</code> to the end of the URL. e.g. <code>https://www.example.com/user/sam.json</code> and see the JSON in your web browser or via an http request (e.g. using <code>curl</code>).</p>
<h2>Activities and Objects</h2>
<h3>Users and relationships</h3>
<p>User relationship interactions follow the standard ActivityPub spec.</p>
<ul>
<li><code>Follow</code>: request to receive statuses from a user, and view their statuses that have followers-only privacy</li>
<li><code>Accept</code>: approves a <code>Follow</code> and finalizes the relationship</li>
<li><code>Reject</code>: denies a <code>Follow</code></li>
<li><code>Block</code>: prevent users from seeing one another's statuses, and prevents the blocked user from viewing the actor's profile</li>
<li><code>Update</code>: updates a user's profile and settings</li>
<li><code>Delete</code>: deactivates a user</li>
<li><code>Undo</code>: reverses a <code>Follow</code> or <code>Block</code></li>
<li><code>Move</code>: communicate that a user has changed their ID and has moved to a new server. Most ActivityPub software will "follow" the user to the new identity. BookWyrm sends a notification to followers and requires them to confirm they want to follow the user to their new identity.</li>
</ul>
<h3>Statuses</h3>
<h4>Object types</h4>
<ul>
<li><code>Note</code>: On services like Mastodon, <code>Note</code>s are the primary type of status. They contain a message body, attachments, can mention users, and be replies to statuses of any type. Within BookWyrm, <code>Note</code>s can only be created as direct messages or as replies to other statuses.</li>
<li><code>Review</code>: A review is a status in response to a book (indicated by the <code>inReplyToBook</code> field), which has a title, body, and numerical rating between 0 (not rated) and 5.</li>
<li><code>Comment</code>: A comment on a book mentions a book and has a message body.</li>
<li><code>Quotation</code>: A quote has a message body, an excerpt from a book, and mentions a book.</li>
</ul>
<h4>Activities</h4>
<ul>
<li>
<p><code>Create</code>: saves a new status in the database.</p>
<p><strong>Note</strong>: BookWyrm only accepts <code>Create</code> activities if they are:</p>
<ul>
<li>Direct messages (i.e., <code>Note</code>s with the privacy level <code>direct</code>, which mention a local user),</li>
<li>Related to a book (of a custom status type that includes the field <code>inReplyToBook</code>),</li>
<li>Replies to existing statuses saved in the database</li>
</ul>
</li>
<li>
<p><code>Delete</code>: Removes a status</p>
</li>
<li><code>Like</code>: Creates a favorite on the status</li>
<li><code>Announce</code>: Boosts the status into the actor's timeline</li>
<li><code>Undo</code>: Reverses a <code>Like</code> or <code>Announce</code></li>
</ul>
<h3>Collections</h3>
<p>User's books and lists are represented by <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-orderedcollection"><code>OrderedCollection</code></a></p>
<h4>Objects</h4>
<ul>
<li><code>Shelf</code>: A user's book collection. By default, every user has a <code>to-read</code>, <code>reading</code>, and <code>read</code> shelf which are used to track reading progress.</li>
<li><code>List</code>: A collection of books that may have items contributed by users other than the one who created the list.</li>
</ul>
<h4>Activities</h4>
<ul>
<li><code>Create</code>: Adds a shelf or list to the database.</li>
<li><code>Delete</code>: Removes a shelf or list.</li>
<li><code>Add</code>: Adds a book to a shelf or list.</li>
<li><code>Remove</code>: Removes a book from a shelf or list.</li>
</ul>
<h2>Alternative Serialization</h2>
<p>Because BookWyrm uses custom object types (<code>Review</code>, <code>Comment</code>, <code>Quotation</code>) that aren't supported by ActivityPub, statuses are transformed into standard types when sent to or viewed by non-BookWyrm services. <code>Review</code>s are converted into <code>Article</code>s, and <code>Comment</code>s and <code>Quotation</code>s are converted into <code>Note</code>s, with a link to the book and the cover image attached.</p>
<p>This may change in future in favor of the more ActivityPub-compliant <a href="https://www.w3.org/TR/activitystreams-core/#fig-following-is-an-example-object-that-uses-the-id-and-type-properties-to-express-the-global-identifier-and-object-type">extended Object types</a> listed alongside core ActivityPub types.</p>
<h2>Making ActivityPub-aware models</h2>
<p>The way BookWyrm sends and receives ActivityPub objects can be confusing for developers who are new to BookWyrm. It is mostly controlled by:</p>
<ul>
<li>Functions and <a href="https://docs.python.org/3/library/dataclasses.html">data classes</a> outlined in the <a href="https://github.com/bookwyrm-social/bookwyrm/tree/main/bookwyrm/activitypub">activitypub</a> directory</li>
<li>The <a href="https://github.com/bookwyrm-social/bookwyrm/blob/c458cdcb992a36f3c4a06752499461c3dd991e07/bookwyrm/models/activitypub_mixin.py#L40">ActivitypubMixin</a> and its children for models that are serializable for ActivityPub requests</li>
</ul>
<h3>Serializing data to and from ActivityPub JSON</h3>
<p>BookWyrm needs to know how to <em>serialize</em> the data from the model into an ActivityPub JSON-LD object.</p>
<p>The <code>/activitypub/base_activity.py</code> file provides the core functions that turn ActivityPub JSON-LD strings into usable Django model objects, and vice-versa. We do this by creating a data class in <code>bookwyrm/activitypub</code>, and defining how the model should be serialized by providing an <code>activity_serializer</code> value in the model, which points to the relevant data class. From <code>ActivityObject</code> we inherit <code>id</code> and <code>type</code>, and two <em>class methods</em>:</p>
<p><strong><code>to_model</code></strong></p>
<p>This method takes an ActivityPub JSON string and tries to turn it into a BookWyrm model object, finding an existing object wherever possible. This is how we process <strong>incoming</strong> ActivityPub objects.</p>
<p><strong><code>serialize</code></strong></p>
<p>This method takes a BookWyrm model object, and turns it into a valid ActivityPub JSON string using the dataclass definitions. This is how we process <strong>outgoing</strong> ActivityPub objects.</p>
<h3>Example - Users</h3>
<p>A BookWyrm user <a href="https://github.com/bookwyrm-social/bookwyrm/blob/main/bookwyrm/models/user.py">is defined in <code>models/user.py</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">OrderedCollectionPageMixin</span><span class="p">,</span> <span class="n">AbstractUser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a user who wants to read books&quot;&quot;&quot;</span>
</code></pre></div>

<p>Notice that we are inheriting from ("subclassing") <code>OrderedCollectionPageMixin</code>. This in turn inherits from <code>ObjectMixin</code>, which inherits from <code>ActivitypubMixin</code>. This may seem convoluted, but this inheritence chain allows us to avoid duplicating code as our ActivityPub objects become more specific. <code>AbstractUser</code> is <a href="https://docs.djangoproject.com/en/5.1/topics/auth/customizing/#specifying-custom-user-model">a Django model intended to be subclassed</a>, giving us things like hashed password logins and permission levels "out of the box".</p>
<p>Because <code>User</code> inherits from <a href="https://github.com/bookwyrm-social/bookwyrm/blob/c458cdcb992a36f3c4a06752499461c3dd991e07/bookwyrm/models/activitypub_mixin.py#L213"><code>ObjectMixin</code></a>, when we <code>save()</code> a <code>User</code> object we will send a <code>Create</code> activity (if this is the first time the user was saved) or an <code>Update</code> activity (if we're just saving a change – e.g. to the user description or avatar). Any other model you add to BookWyrm will have the same capability if it inherits from <code>ObjectMixin</code>.</p>
<p>For BookWyrm users, the <code>activity_serializer</code> is defined in the <code>User</code> model:</p>
<div class="highlight"><pre><span></span><code><span class="n">activity_serializer</span> <span class="o">=</span> <span class="n">activitypub</span><span class="o">.</span><span class="n">Person</span>
</code></pre></div>

<p>The data class definition for <code>activitypub.Person</code> is at <code>/activitypub/person.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">ActivityObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;actor activitypub json&quot;&quot;&quot;</span>

    <span class="n">preferredUsername</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">inbox</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">publicKey</span><span class="p">:</span> <span class="n">PublicKey</span>
    <span class="n">followers</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">following</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">outbox</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">endpoints</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">icon</span><span class="p">:</span> <span class="n">Image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bookwyrmUser</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">manuallyApprovesFollowers</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">discoverable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">hideFollows</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">movedTo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alsoKnownAs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Person&quot;</span>
</code></pre></div>

<p>You might notice that some of these fields are not a perfect match to the fields in the <code>User</code> model. If you have a field name in your model that needs to be called something different in the ActivityPub object (e.g. to comply with Python naming conventions in the model but JSON naming conventions in JSON string), you can define an <code>activitypub_field</code> in the model field definition:</p>
<div class="highlight"><pre><span></span><code><span class="n">followers_url</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">activitypub_field</span><span class="o">=</span><span class="s2">&quot;followers&quot;</span><span class="p">)</span>
</code></pre></div>
</section>

        </div>
    </div>
</section>
</div>

<footer id="contentinfo" class="footer">
    <div class="container is-max-desktop">
        <div class="columns">
            <div class="column content">
                <p>
                    <strong>BookWyrm</strong> is collaborative, anti-corporate software maintained by <a href='https://www.mousereeve.com/'>Mouse Reeve</a>.
                </p>
                <p>
                    Support BookWyrm on <a href='https://www.patreon.com/bookwyrm' target='_blank'>Patreon</a>.
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">Get Involved</h3>
                <p>
                    <a href="https://github.com/bookwyrm-social">BookWyrm on GitHub</a>
                </p>
                <p>
                    <a href="https://github.com/bookwyrm-social/documentation/blob/main/content/codebase/activitypub.md">Contribute to this page</a>
                </p>
                <p>
                    <a href="https://twitter.com/BookWyrmSocial" target="_blank">
                        <span class="icon icon-twitter"><span class="is-sr-only">Twitter</span></span>
                    </a>
                    <a href="https://tech.lgbt/@bookwyrm" target="_blank" rel="me">
                        <span class="icon icon-mastodon"><span class="is-sr-only">Mastodon</span></span>
                    </a>
                    <a href="https://www.patreon.com/bookwyrm" target="_blank">
                        <span class="icon icon-patreon"><span class="is-sr-only">Patreon</span></span>
                    </a>
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">Learn more</h3>
                <p>
                    <a href="https://docs.joinbookwyrm.com">Documentation</a>
                </p>
                <p>
                    <a href="mailto:mousereeve@riseup.net">Contact maintainer</a>
                </p>
                <p>
                    <a href="https://raw.githubusercontent.com/bookwyrm-social/join-bookwyrm/main/LICENSE.md">License</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
    (function() {
        var languageSelector = document.getElementById("language_selection");
        languageSelector.onchange = function(event) {
            var current_locale = "";
            var current_location = window.location.pathname;

            var locale_index = current_location.indexOf(current_locale);
            var new_location = "/" + event.target.value;

            if (locale_index) {
                new_location += current_location.slice(locale_index + current_locale.length);
            } else {
                new_location += current_location.slice(1);
            }

            window.location = new_location;
        }
    })()
</script>
<script type="text/javascript">
    (function() {
        var versionSelector = document.getElementById("version_selection");
        versionSelector.onchange = function(event) {
            var current_version = "";
            console.log(current_version)
            var current_location = window.location.pathname;
            var version_index = current_location.indexOf(current_version);
            var new_location = "/" + event.target.value;

            console.log(current_location)
            console.log(new_location)

            if (version_index) {
                new_location += current_location.slice(version_index + current_version.length) + "/";
            } else {
                console.log("no version_index")
                new_location += `/${current_location.slice(1)}`;
            }

            window.location = new_location;
        }
    })()
</script>


</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <title>
        
Stockage Externe

    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="/static/css/icons.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bulma.min.css">
    <link type="text/css" rel="stylesheet" href="/static/css/bookwyrm.css?v076">

    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Bookwyrm Documentation">
    <meta name="og:title" content="Bookwyrm Documentation">
    <meta name="twitter:description" content="Documentation for using and contributing to BookWyrm">
    <meta name="og:description" content="Documentation for using and contributing to BookWyrm">

    <meta name="twitter:image" content="">
    <meta name="og:image" content="">
    <meta name="twitter:image:alt" content="BookWyrm Logo">

    <meta charset="UTF-8">
</head>
<body>
<nav class="navbar container is-max-desktop" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="https://joinbookwyrm.com/">
            <img class="image logo" src="/static/images/logo-small.png" alt="Go back to the homepage">
        </a>
        <a href="/" class="navbar-item has-text-link has-text-weight-bold">
            Documentation
        </a>
        <a role="button" class="navbar-burger" data-target="main-nav" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div class="navbar-menu" id="main-nav">
        <div class="navbar-start">
            <a href="https://joinbookwyrm.com/fr/instances" class="navbar-item">
                Rejoindre
            </a>
            <a href="https://joinbookwyrm.com/fr/get-involved" class="navbar-item">
                S'impliquer dans le projet
            </a>
            <a href="https://www.patreon.com/bookwyrm" class="navbar-item">
                Soutenir
            </a>
            <a href="https://github.com/bookwyrm-social/bookwyrm" class="navbar-item">
                Code
            </a>
        </div>
    </div>
</nav>

<div class="columns">
    <nav class="menu column is-one-quarter is-hidden-touch pl-6 mt-4" id="menu">
        <h2 class="menu-label">Language & Version</a></h2>
        <div class="select">
            <select aria-label="Select a language" id="language_selection">
                
                <option value="" >English (US)</option>
                
                <option value="de/" >Deutsch</option>
                
                <option value="fr/" selected>Français</option>
                
                <option value="pl/" >Polski</option>
                
                <option value="pt-br/" >Português do Brasil</option>
                
                <option value="ro/" >Română</option>
                
          </select>
        </div>
        <div class="select">
            <select aria-label="Previous versions" id="version_selection">
                
                <option value="latest" >latest</option>
                
                <option value="v0.7.5" >v0.7.5</option>
                
            </select>
        </div>
        
        <h2 class="menu-label">Using BookWyrm</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/fr/posting-statuses.html" class="has-background-inherit" >Posting Statuses</a>
            </li>
            
            <li>
                <a href="/fr/privacy-controls.html" class="has-background-inherit" >Privacy Controls</a>
            </li>
            
            <li>
                <a href="/fr/adding-books.html" class="has-background-inherit" >Ajout de livres</a>
            </li>
            
            <li>
                <a href="/fr/lists.html" class="has-background-inherit" >Lists</a>
            </li>
            
            <li>
                <a href="/fr/groups.html" class="has-background-inherit" >Groups</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Running BookWyrm</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/fr/reverse-proxy.html" class="has-background-inherit" ></a>
            </li>
            
            <li>
                <a href="/fr/moderation.html" class="has-background-inherit" >Modération</a>
            </li>
            
            <li>
                <a href="/fr/install-prod.html" class="has-background-inherit" >Installation en Production</a>
            </li>
            
            <li>
                <a href="/fr/install-prod-dockerless.html" class="has-background-inherit" >Installation sans Docker</a>
            </li>
            
            <li>
                <a href="/fr/updating.html" class="has-background-inherit" >Mise à jour de votre instance</a>
            </li>
            
            <li>
                <a href="/fr/monitoring-queue.html" class="has-background-inherit" >Suivi de la file d'attente</a>
            </li>
            
            <li>
                <a href="/fr/external-storage.html" class="has-background-inherit" class="is-active">Stockage Externe</a>
            </li>
            
            <li>
                <a href="/fr/optional_features.html" class="has-background-inherit" >Fonctionnalités optionnelles</a>
            </li>
            
            <li>
                <a href="/fr/cli.html" class="has-background-inherit" >Outils en ligne de commande</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Contributing</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/fr/contributing.html" class="has-background-inherit" >Comment contribuer</a>
            </li>
            
            <li>
                <a href="/fr/translation.html" class="has-background-inherit" >Translations</a>
            </li>
            
            <li>
                <a href="/fr/style_guide.html" class="has-background-inherit" >Style Guide</a>
            </li>
            
            <li>
                <a href="/fr/install-dev.html" class="has-background-inherit" >Developer Environment</a>
            </li>
            
            <li>
                <a href="/fr/debug_toolbar.html" class="has-background-inherit" >Django Debug Toolbar</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Codebase</h2>
        <ul class="menu-list has-background-inherit">
            
            <li>
                <a href="/fr/activitypub.html" class="has-background-inherit" >ActivityPub</a>
            </li>
            
            <li>
                <a href="/fr/permissions.html" class="has-background-inherit" >Permissions</a>
            </li>
            
        </ul>
        
        <h2 class="menu-label">Reference Guides</h2>
        <ul class="menu-list has-background-inherit">
            
        </ul>
        
    </nav>

    <div class="column">
        <div class="container is-max-desktop">
            <section class="section">
                <header class="content block column is-offset-one-quarter pl-2">
                    
<h1 class="title is-1">Stockage Externe</h1>

                </header>
                
<section class="block content">
    <p>Par défaut, BookWyrm stocke localement les ressources statiques (favicon, avatar par défaut, etc.) et les médias (avatars, couvertures de livres, etc.), mais vous pouvez utiliser un service de stockage externe pour ces fichiers. BookWyrm utilise <code>django-storages</code> pour gérer le stockage externe, tel que les services compatibles S3, Apache Libcloud ou SFTP.</p>
<h2 id="services-compatibles-s3"><a class="headerlink" href="#services-compatibles-s3">Services compatibles S3</a></h2>
<h3 id="configuration"><a class="headerlink" href="#configuration">Configuration</a></h3>
<p>Créez un compartiment auprès du service compatible S3 de votre choix, ainsi qu'un ID de clé d'accès et une clé d'accès secrète. Ceux-ci peuvent être auto-hébergés, tels que <a href="https://ceph.io/en/">Ceph</a> (LGPL 2.1/3.0) ou <a href="https://min.io/">MinIO</a> (GNU AGPL v3.0), ou commerciaux (<a href="https://www.scaleway.com/en/docs/object-storage-feature/">Scaleway</a>, <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-digitalocean-space-and-api-key">Digital Ocean</a>...).</p>
<p>Ce guide a été testé avec Object Storage de Scaleway. Si vous utiliser un autre service, partagez votre expérience (en particulier si vous avez dû prendre des mesures différentes) en ouvrant un ticket sur le dépôt de la <a href="https://github.com/bookwyrm-social/documentation">Documentation de BookWyrm</a>.</p>
<h3 id="ce-qui-vous-attend"><a class="headerlink" href="#ce-qui-vous-attend">Ce qui vous attend</a></h3>
<p>Si vous installez une nouvelle instance de BookWyrm, les étapes seront :</p>
<ul>
<li>Configurer votre service de stockage externe</li>
<li>Activer le stockage externe sur BookWyrm</li>
<li>Démarrer votre instance BookWyrm</li>
<li>Mettre à jour le connecteur de l'instance</li>
</ul>
<p>Si votre instance est déjà en place, et que des images ont été téléchargées sur le stockage local, les étapes seront :</p>
<ul>
<li>Configurer votre service de stockage externe</li>
<li>Copier vos médias locaux sur le stockage externe</li>
<li>Activer le stockage externe sur BookWyrm</li>
<li>Redémarrer votre instance BookWyrm</li>
<li>Mettre à jour le connecteur de l'instance</li>
</ul>
<h3 id="parametres-de-bookwyrm"><a class="headerlink" href="#parametres-de-bookwyrm">Paramètres de BookWyrm</a></h3>
<p>Modifiez votre fichier <code>.env</code> en décommentant les lignes suivantes :</p>
<ul>
<li><code>AWS_ACCESS_KEY_ID</code>: votre ID de clé d'accès</li>
<li><code>AWS_SECRET_ACCESS_KEY</code>: votre clé d'accès secrète</li>
<li><code>AWS_STORAGE_BUCKET_NAME</code>: le nom de votre compartiment</li>
<li><code>AWS_S3_REGION_NAME</code>: e.g. <code>"eu-west-1"</code> pour AWS, <code>"fr-par"</code> pour Scaleway ou <code>"nyc3"</code> pour Digital Ocean</li>
</ul>
<p>Si votre service compatible S3 est Amazon AWS, la configuration devrait être terminée. Pour les autres services, vous aurez à décommenter les lignes suivantes :</p>
<ul>
<li><code>AWS_S3_CUSTOM_DOMAIN</code>: le domaine qui va mettre à disposition les fichiers, par exemple <code>"exemple-nom-compartiment-s3.fr-par.scw.cloud"</code> ou <code>"${AWS_STORAGE_BUCKET_NAME}.${AWS_S3_REGION_NAME}.digitaloceanspaces.com"</code></li>
<li><code>AWS_S3_ENDPOINT_URL</code>: le point de terminaison d'API S3, par exemple <code>"https://s3.fr-par.scw.cloud"</code> ou <code>"https://${AWS_S3_REGION_NAME}.digitaloceanspaces.com"</code></li>
</ul>
<h3 id="copie-de-vos-medias-locaux-sur-le-stockage-externe"><a class="headerlink" href="#copie-de-vos-medias-locaux-sur-le-stockage-externe">Copie de vos médias locaux sur le stockage externe</a></h3>
<p>Si votre instance BookWyrm est déjà en cours d'exécution et que des fichiers médias ont été téléchargés (avatars d'utilisateur, couvertures de livres…), vous devrez copier les médias téléchargés sur votre compartiment.</p>
<p>Cette tâche est effectuée avec la commande :</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>copy_media_to_s3
</code></pre></div>

<h3 id="activation-du-stockage-externe-sur-bookwyrm"><a class="headerlink" href="#activation-du-stockage-externe-sur-bookwyrm">Activation du stockage externe sur BookWyrm</a></h3>
<p>Pour activer le stockage externe compatible S3, vous devrez modifier votre fichier <code>.env</code> en changeant la valeur de la propriété <code>USE_S3</code> de <code>false</code> à <code>true</code>:</p>
<div class="highlight"><pre><span></span><code>USE_S3=true
</code></pre></div>

<p>Si votre stockage externe est accessible via HTTPS (la plupart le sont actuellement), vous devrez également vous assurer que <code>USE_HTTPS</code> est défini à <code>true</code>, afin que les images soient téléchargées via HTTPS :</p>
<div class="highlight"><pre><span></span><code>USE_HTTPS=true
</code></pre></div>

<h4 id="ressources-statiques"><a class="headerlink" href="#ressources-statiques">Ressources statiques</a></h4>
<p>Vous devrez ensuite exécuter la commande suivante, afin de copier les ressources statiques vers votre compartiment S3 :</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>collectstatic
</code></pre></div>

<h4 id="parametres-cors"><a class="headerlink" href="#parametres-cors">Paramètres CORS</a></h4>
<p>Une fois que les ressources statiques ont été recueillies, vous devrez configurer CORS pour votre compartiment.</p>
<p>Certains services tels que Digital Ocean mettent à disposition une interface pour cette étape, voir <a href="https://docs.digitalocean.com/products/spaces/how-to/configure-cors/">Documentation de Digital Ocean: Comment configurer CORS</a>.</p>
<p>Si votre service ne met pas d'interface à disposition, vous pouvez tout de même configurer CORS via la ligne de commande.</p>
<p>Créez un fichier nommé <code>cors.json</code> avec le contenu suivant :</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;CORSRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;AllowedOrigins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://MY_DOMAIN_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;https://www.MY_DOMAIN_NAME&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;AllowedHeaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;AllowedMethods&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;MaxAgeSeconds&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;ExposeHeaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Etag&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>Remplacez <code>MY_DOMAIN_NAME</code> par le(s) nom(s) de domaine de votre instance.</p>
<p>Exécutez alors la commande suivante :</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>set_cors_to_s3<span class="w"> </span>cors.json
</code></pre></div>

<p>Une absence de retour signifie que cela a fonctionné.</p>
<p>Si vous installez une nouvelle instance de BookWyrm, vous pouvez retourner aux instructions de configuration dès maintenant. Dans le cas contraire, continuez à lire.</p>
<h3 id="redemarrage-de-votre-instance"><a class="headerlink" href="#redemarrage-de-votre-instance">Redémarrage de votre instance</a></h3>
<p>Une fois la copie des fichiers médias effectuée et les ressources statiques recueillies, vous pouvez charger la nouvelle configuration <code>.env</code> et redémarrer votre instance avec la commande :</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>

<p>Si tout se passe bien, votre stockage a été modifié sans arrêt du serveur. Si des polices sont manquantes (et que la console JS de votre navigateur génère des alertes à propos de CORS), quelque chose s'est mal passé <a href="#cors-settings">à cette étape</a>. Dans ce cas, il peut être bon de vérifier les en-têtes d'une requête HTTP pour un fichier sur votre compartiment :</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>OPTIONS<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Origin: http://MY_DOMAIN_NAME&#39;</span><span class="w"> </span>http://BUCKET_URL/static/images/logo-small.png<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Access-Control-Request-Method: GET&quot;</span>
</code></pre></div>

<p>Remplacez <code>MY_DOMAIN_NAME</code> par votre nom de domaine de l'instance, <code>BUCKET_URL</code> avec l'URL de votre compartiment, et le chemin du fichier par n'importe quel autre chemin valide sur votre compartiment.</p>
<p>Si vous voyez un message, en particulier un message commençant par <code>&lt;Error&gt;&lt;Code&gt;CORSForbidden&lt;/Code&gt;</code>, cela n'a pas fonctionné. Si vous ne voyez aucun message, cela a fonctionné.</p>
<p>Pour une instance en cours d'utilisation, il peut y avoir quelques fichiers qui ont été créés localement pendant l'intervalle entre la migration des fichiers vers le stockage externe et le redémarrage de l'application. Pour s'assurer que tous les fichiers restants sont téléchargés sur le stockage externe une fois basculé dessus, vous pouvez utiliser la commande suivante, qui copiera uniquement les fichiers qui ne sont pas déjà présents sur le stockage externe :</p>
<div class="highlight"><pre><span></span><code>./bw-dev<span class="w"> </span>sync_media_to_s3
</code></pre></div>

<h3 id="mise-a-jour-du-connecteur-de-linstance"><a class="headerlink" href="#mise-a-jour-du-connecteur-de-linstance">Mise à jour du connecteur de l'instance</a></h3>
<p><em>Remarque : Vous pouvez sauter cette étape si vous utilisez une version à jour de BookWyrm; en septembre 2021 le « self connector » a été retiré dans <a href="https://github.com/bookwyrm-social/bookwyrm/pull/1413">PR #1413</a></em></p>
<p>Afin que la bonne URL soit utilisée lors de l'affichage des résultats de recherche locale de livres, nous devons modifier la valeur de la racine d'URL des images de couverture.</p>
<p>Les données du connecteur sont accessibles via l'interface d'administration de Django, située à l'url <code>http://MY_DOMAIN_NAME/admin</code>. Le connecteur pour votre propre instance est le premier enregistrement dans la base de données, vous pouvez donc accéder au connecteur via cette URL : <code>https://MY_DOMAIN_NAME/admin/bookwyrm/connector/1/change/</code>.</p>
<p>Le champ <em>Covers url</em> est défini par défaut comme <code>https://MY_DOMAIN_NAME/images</code>, vous devez le changer en <code>https://S3_STORAGE_URL/images</code>. Ensuite, cliquez sur le bouton <em>Enregistrer</em>.</p>
<p>Vous devrez mettre à jour la valeur de <em>Covers url</em> chaque fois que vous changez l'URL de votre stockage.</p>
</section>

            </section>
        </div>
    </div>
</div>

<footer id="contentinfo" class="footer">
    <div class="container is-max-desktop">
        <div class="columns">
            <div class="column content">
                <p>
                    <strong>BookWyrm</strong> est un logiciel collaboratif et anti-commercial maintenu par <a href='https://www.mousereeve.com/'>Mouse Reeve</a>.
                </p>
                <p>
                    Soutenir BookWyrm sur <a href='https://www.patreon.com/bookwyrm' target='_blank'>Patreon</a>.
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">Contribuer</h3>
                <p>
                    <a href="https://github.com/bookwyrm-social">BookWyrm sur GitHub</a>
                </p>
                <p>
                    <a href="https://github.com/bookwyrm-social/documentation/blob/main/content/running_bookwyrm/external-storage.md">Contribuer à cette page</a>
                </p>
                <p>
                    <a href="https://twitter.com/BookWyrmSocial" target="_blank">
                        <span class="icon icon-twitter"><span class="is-sr-only">Twitter</span></span>
                    </a>
                    <a href="https://tech.lgbt/@bookwyrm" target="_blank" rel="me">
                        <span class="icon icon-mastodon"><span class="is-sr-only">Mastodon</span></span>
                    </a>
                    <a href="https://www.patreon.com/bookwyrm" target="_blank">
                        <span class="icon icon-patreon"><span class="is-sr-only">Patreon</span></span>
                    </a>
                </p>
            </div>
            <div class="column">
                <h3 class="title is-6">En savoir plus</h3>
                <p>
                    <a href="https://docs.joinbookwyrm.com">Documentation</a>
                </p>
                <p>
                    <a href="mailto:mousereeve@riseup.net">Contact</a>
                </p>
                <p>
                    <a href="https://raw.githubusercontent.com/bookwyrm-social/join-bookwyrm/main/LICENSE.md">Licence</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<script>
    var current_locale = "fr/";
</script>
<script src="/static/js/bookwyrm.js"></script>
</body>
</html>